<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>æ—¶å…‰èƒ¶å›Š Â· Time Capsule</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Firebase (compat for GitHub Pages) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
/* ğŸ“Œ PINNED MESSAGE STYLE */
.card.pinned-card {
  border: 1px solid #facc15;
  background: linear-gradient(145deg, #1e1b04, #020617);
}

.pinned {
  color: #facc15;
  font-size: 12px;
  margin-bottom: 6px;
  font-weight: 700;
}

body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
  background: #0f172a;
  color: #e5e7eb;
  margin: 0;
  padding: 20px;
}

h1 { text-align: center; margin-bottom: 5px; }
.subtitle { text-align: center; color: #94a3b8; margin-bottom: 30px; font-size: 14px; }
.container { max-width: 720px; margin: auto; }
textarea, input { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px; border: none; outline: none; font-size: 15px; }
textarea { resize: none; height: 110px; }
button { width: 100%; padding: 12px; border-radius: 10px; border: none; background: #38bdf8; color: #020617; font-size: 16px; cursor: pointer; font-weight: 600; }
button:hover { background: #0ea5e9; }
.search { margin: 30px 0 15px; }
.card { background: #020617; padding: 15px; border-radius: 12px; margin-bottom: 12px; border: 1px solid #1e293b; }
.meta { font-size: 12px; color: #64748b; margin-top: 8px; }
.pinned { color: #38bdf8; font-size: 12px; margin-bottom: 6px; font-weight: 600; }
.footer { text-align: center; font-size: 12px; color: #64748b; margin-top: 40px; }
.corner-label { position: fixed; top: 15px; font-weight: bold; color: white; font-family: 'Segoe UI', 'Roboto', sans-serif; font-size: 22px; letter-spacing: 1px; text-shadow: 0 0 8px rgba(0,0,0,0.6); z-index: 1000; opacity: 0.85; transition: opacity 0.2s, transform 0.2s; }
.corner-label:hover { opacity: 1; transform: scale(1.1); }
</style>
</head>
<body>

<div class="corner-label" style="left: 20px;">@huiya</div>
<div class="corner-label" style="right: 20px;">@night_version</div>

<div class="container">
  <h1>æ—¶å…‰èƒ¶å›Š Â· Time Capsule</h1>
  <div class="subtitle">
    å†™ç»™æœªæ¥çš„è‡ªå·± Â· Messages to Your Future Self
  </div>

  <textarea id="message" placeholder="å†™ä¸‹ä¸€æ®µç»™æœªæ¥çš„è‡ªå·±çš„è¯â€¦ Write a message to your future self"></textarea>
  <input id="year" placeholder="ç›®æ ‡å¹´ä»½ï¼ˆå¯é€‰ï¼Œä¾‹å¦‚ 2028ï¼‰ Â· Target year (optional)">
  <button onclick="submitMessage()">å°å­˜åˆ°æ—¶å…‰èƒ¶å›Š Â· Seal into Time Capsule</button>
  <input class="search" id="search" placeholder="æœç´¢æ¶ˆæ¯æˆ–å¹´ä»½â€¦ Search messages or yearâ€¦" oninput="renderMessages()">
  <div id="messages"></div>
  <div class="footer">åŒ¿å Â· æ— éœ€ç™»å½• Â· Anonymous Â· No login required</div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDBxLmSFIyfPLHx0FKNcfjr1Na5_vqHaKo",
  authDomain: "time-capsule-45680.firebaseapp.com",
  projectId: "time-capsule-45680",
  storageBucket: "time-capsule-45680.firebasestorage.app",
  messagingSenderId: "881797225588",
  appId: "1:881797225588:web:844881b2953a1d16d14521",
  measurementId: "G-JQDKNH5YEE"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let allMessages = [];
let devMode = false; // ephemeral, reset on refresh

function submitMessage() {
  let text = message.value.trim();
  const yearValue = year.value.trim();

  // Enable Dev Mode only when typing secret
  if (text === "LiZhengHuiADMIN") {
    devMode = true;
    alert("Dev Mode enabled! ğŸ‰ Pin/Unpin/Delete buttons are now visible.");
    message.value = "";
    renderMessages(); // re-render to show Dev Mode buttons
    return;
  }

  if (!text) { alert("æ¶ˆæ¯ä¸èƒ½ä¸ºç©º / Message cannot be empty"); return; }

  let pinned = false;
  const pinMatch = text.match(/^pin\(([\s\S]+)\)$/i);
  if (pinMatch) { pinned = true; text = pinMatch[1].trim(); }

  if (text.length > 300) { alert("æ¶ˆæ¯å¤ªé•¿ï¼ˆæœ€å¤š 300 å­—ï¼‰ / Message too long"); return; }

  db.collection("messages").add({
    text: text,
    year: yearValue || "æœªæ¥ / Future",
    pinned: pinned,
    priority: pinned ? 1 : 0,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  message.value = "";
  year.value = "";
}

// Firestore listener
db.collection("messages")
  .onSnapshot(snapshot => {
    allMessages = snapshot.docs.map(doc => ({ ...doc.data(), _id: doc.id }))
                               .filter(d => d.createdAt);

    // Sort pinned first, then newest
    allMessages.sort((a, b) => {
      if (a.pinned && !b.pinned) return -1;
      if (!a.pinned && b.pinned) return 1;
      if (a.createdAt && b.createdAt) return b.createdAt.seconds - a.createdAt.seconds;
      return 0;
    });

    renderMessages();
  });

function renderMessages() {
  const keyword = search.value.toLowerCase();
  const container = document.getElementById("messages");
  container.innerHTML = "";

  allMessages.forEach(m => {
    if (m.text.toLowerCase().includes(keyword) || (m.year && m.year.toLowerCase().includes(keyword))) {
      const div = document.createElement("div");
      div.className = "card" + (m.pinned ? " pinned-card" : "");
      div.innerHTML = `
        ${m.pinned ? `<div class="pinned">ğŸ“Œ PINNED</div>` : ""}
        <div>${escapeHTML(m.text)}</div>
        <div class="meta">ğŸ“… ${m.year}</div>
      `;

      // Show Dev Mode buttons only if devMode is active
      if (devMode) {
        const adminMenu = document.createElement("div");
        adminMenu.style.marginTop = "6px";
        adminMenu.style.display = "flex";
        adminMenu.style.gap = "6px";

        const pinBtn = document.createElement("button");
        pinBtn.textContent = "ğŸ“Œ Pin";
        pinBtn.style.fontSize = "12px"; pinBtn.style.padding = "3px 6px";
        pinBtn.onclick = e => {
          e.stopPropagation();
          db.collection("messages").doc(m._id).update({ pinned: true })
            .catch(err => alert("Error pinning: " + err));
        };

        const unpinBtn = document.createElement("button");
        unpinBtn.textContent = "ğŸ“ Unpin";
        unpinBtn.style.fontSize = "12px"; unpinBtn.style.padding = "3px 6px";
        unpinBtn.onclick = e => {
          e.stopPropagation();
          db.collection("messages").doc(m._id).update({ pinned: false })
            .catch(err => alert("Error unpinning: " + err));
        };

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "ğŸ—‘ Delete";
        deleteBtn.style.fontSize = "12px"; deleteBtn.style.padding = "3px 6px";
        deleteBtn.onclick = e => {
          e.stopPropagation();
          if (confirm("Delete this message permanently?")) {
            db.collection("messages").doc(m._id).delete()
              .catch(err => alert("Error deleting: " + err));
          }
        };

        adminMenu.appendChild(pinBtn);
        adminMenu.appendChild(unpinBtn);
        adminMenu.appendChild(deleteBtn);
        div.appendChild(adminMenu);
      }

      container.appendChild(div);
    }
  });
}

function escapeHTML(str) {
  return str.replace(/[&<>"']/g, m => ({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' })[m]);
}
</script>
</body>
</html>
