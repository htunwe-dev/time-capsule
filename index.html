<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<title>æ—¶å…‰èƒ¶å›Š Â· Time Capsule</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
.card.pinned-card {
  border: 1px solid #facc15;
  background: linear-gradient(145deg, #1e1b04, #020617);
}
.pinned {
  color: #facc15;
  font-size: 12px;
  margin-bottom: 6px;
  font-weight: 700;
}
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
  background: #0f172a;
  color: #e5e7eb;
  margin: 0;
}
h1 {
  text-align: center;
  margin-bottom: 5px;
}
.subtitle {
  text-align: center;
  color: #94a3b8;
  margin-bottom: 30px;
  font-size: 14px;
}
.container {
  max-width: 720px;
  margin: auto;
  padding: 20px; /* move padding here instead of body */
  box-sizing: border-box; /* include padding in width calculation */
}
textarea,
input {
  width: 100%;
  padding: 12px;
  margin-bottom: 10px;
  border-radius: 10px;
  border: none;
  outline: none;
  font-size: 15px;
  box-sizing: border-box; /* ensures full width including padding */
}
textarea {
  resize: none;
  height: 110px;
}
button {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: none;
  background: #38bdf8;
  color: #020617;
  font-size: 16px;
  cursor: pointer;
  font-weight: 600;
  display: block;
  margin-bottom: 10px;
  box-sizing: border-box; /* ensure full width */
}
button:hover {
  background: #0ea5e9;
}
.search {
  margin: 30px 0 15px;
}
.card {
  background: #020617;
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 12px;
  border: 1px solid #1e293b;
}
.meta {
  font-size: 12px;
  color: #64748b;
  margin-top: 8px;
}
.pinned {
  color: #38bdf8;
  font-size: 12px;
  margin-bottom: 6px;
  font-weight: 600;
}
.footer {
  text-align: center;
  font-size: 12px;
  color: #64748b;
  margin-top: 40px;
}
.corner-label {
  position: fixed;
  top: 15px;
  font-weight: bold;
  color: white;
  font-family: 'Segoe UI', 'Roboto', sans-serif;
  font-size: 22px;
  letter-spacing: 1px;
  text-shadow: 0 0 8px rgba(0,0,0,0.6);
  z-index: 1000;
  opacity: 0.85;
  transition: opacity 0.2s, transform 0.2s;
}
.corner-label:hover {
  opacity: 1;
  transform: scale(1.1);
}
</style>




</head>
<body>

<div class="corner-label" style="left:20px;">@huiya</div>
<div class="corner-label" style="right:20px;">@night_version</div>

<div class="container">
<h1>æ—¶å…‰èƒ¶å›Š Â· Time Capsule</h1>
<div class="subtitle">å†™ç»™æœªæ¥çš„è‡ªå·± Â· Messages to Your Future Self</div>

<textarea id="message" placeholder="å†™ä¸‹ä¸€æ®µç»™æœªæ¥çš„è‡ªå·±çš„è¯â€¦ Write a message to your future self"></textarea>
<input id="year" placeholder="ç›®æ ‡å¹´ä»½ï¼ˆå¯é€‰ï¼Œä¾‹å¦‚ 2028ï¼‰ Â· Target year (optional)">
<button onclick="submitMessage()">å°å­˜åˆ°æ—¶å…‰èƒ¶å›Š Â· Seal into Time Capsule</button>
<input class="search" id="search" placeholder="æœç´¢æ¶ˆæ¯æˆ–å¹´ä»½â€¦ Search messages or yearâ€¦" oninput="renderMessages()">
<div id="messages"></div>
<div class="footer">åŒ¿å Â· æ— éœ€ç™»å½• Â· Anonymous Â· No login required</div>
</div>

<script>
// -----------------
// Firebase Init
// -----------------
const firebaseConfig = {
  apiKey:"AIzaSyDBxLmSFIyfPLHx0FKNcfjr1Na5_vqHaKo",
  authDomain:"time-capsule-45680.firebaseapp.com",
  projectId:"time-capsule-45680",
  storageBucket:"time-capsule-45680.firebasestorage.app",
  messagingSenderId:"881797225588",
  appId:"1:881797225588:web:844881b2953a1d16d14521",
  measurementId:"G-JQDKNH5YEE"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// -----------------
// DOM Elements
// -----------------
const messageEl = document.getElementById("message");
const yearEl = document.getElementById("year");
const searchEl = document.getElementById("search");
const submitBtn = document.querySelector("button");

// -----------------
// State
// -----------------
let allMessages = [];
let devMode = false;
const DEV_TOKEN = "Admin123";
let sending = false; // prevents duplicate clicks

// -----------------
// Try Dev Mode
// -----------------
async function tryDevMode(code){
  try {
    const snapshot = await db.collection("adminCodes")
      .where("code", "==", code)
      .where("used", "==", false)
      .limit(1)
      .get();
    if(!snapshot.empty){
      const doc = snapshot.docs[0];
      await db.collection("adminCodes").doc(doc.id).update({used:true});
      devMode = true;
      alert("Dev Mode enabled! ğŸ‰ This code cannot be used again.");
      renderMessages();
      return true;
    }
  } catch(err){
    console.error("Dev mode error:", err);
  }
  return false;
}

// -----------------
// Submit Message
// -----------------
async function submitMessage() {
  if(sending) return; // prevent multiple simultaneous submits
  sending = true;
  submitBtn.disabled = true; // visually disable button

  const textValue = messageEl.value.trim();
  const yearValue = yearEl.value.trim();

  if(!textValue){ alert("æ¶ˆæ¯ä¸èƒ½ä¸ºç©º / Message cannot be empty"); sending=false; submitBtn.disabled=false; return; }

  // Check Dev Mode first
  if(await tryDevMode(textValue)){
    messageEl.value = "";
    sending=false;
    submitBtn.disabled=false;
    return;
  }

  let pinned = false;
  let text = textValue;
  const pinMatch = textValue.match(/^pin\(([\s\S]+)\)$/i);
  if(pinMatch){ pinned = true; text = pinMatch[1].trim(); }

  if(text.length > 300){ alert("æ¶ˆæ¯å¤ªé•¿ï¼ˆæœ€å¤š 300 å­—ï¼‰ / Message too long"); sending=false; submitBtn.disabled=false; return; }

  await db.collection("messages").add({
    text: text,
    year: yearValue || "æœªæ¥ / Future",
    pinned: pinned,
    priority: pinned ? 1 : 0,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  messageEl.value = "";
  yearEl.value = "";
  sending=false;
  submitBtn.disabled=false;
}

// -----------------
// Listen to messages
// -----------------
db.collection("messages").orderBy("createdAt","desc").onSnapshot(snapshot => {
  allMessages = snapshot.docs.map(doc => ({...doc.data(), _id: doc.id})).filter(d => d.createdAt);
  allMessages.sort((a,b)=>{
    if(a.pinned && !b.pinned) return -1;
    if(!a.pinned && b.pinned) return 1;
    return 0;
  });
  renderMessages();
});

// -----------------
// Render messages
// -----------------
function renderMessages(){
  const keyword = searchEl.value.toLowerCase();
  const container = document.getElementById("messages");
  container.innerHTML = "";

  allMessages.forEach(m=>{
    if(m.text.toLowerCase().includes(keyword) || (m.year && m.year.toLowerCase().includes(keyword))){
      const div = document.createElement("div");
      div.className = "card" + (m.pinned ? " pinned-card" : "");
      div.innerHTML = `${m.pinned ? `<div class="pinned">ğŸ“Œ PINNED</div>` : ""}<div>${escapeHTML(m.text)}</div><div class="meta">ğŸ“… ${m.year}</div>`;

      if(devMode){
        const menu = document.createElement("div");
        menu.style.display = "flex";
        menu.style.gap = "6px";
        menu.style.marginTop = "6px";

        const pinBtn = document.createElement("button");
        pinBtn.textContent = "ğŸ“Œ Pin";
        pinBtn.style.fontSize="12px"; pinBtn.style.padding="3px 6px";
        pinBtn.onclick = e=>{e.stopPropagation(); db.collection("messages").doc(m._id).update({pinned:true, devToken:DEV_TOKEN});};

        const unpinBtn = document.createElement("button");
        unpinBtn.textContent = "ğŸ“ Unpin";
        unpinBtn.style.fontSize="12px"; pinBtn.style.padding="3px 6px";
        unpinBtn.onclick = e=>{e.stopPropagation(); db.collection("messages").doc(m._id).update({pinned:false, devToken:DEV_TOKEN});};

        const delBtn = document.createElement("button");
        delBtn.textContent = "ğŸ—‘ Delete";
        delBtn.style.fontSize="12px"; delBtn.style.padding="3px 6px";
        delBtn.onclick = e=>{ e.stopPropagation(); if(confirm("Delete permanently?")) db.collection("messages").doc(m._id).delete();};

        menu.append(pinBtn, unpinBtn, delBtn);
        div.appendChild(menu);
      }

      container.appendChild(div);
    }
  });
}

// -----------------
// Escape HTML
// -----------------
function escapeHTML(str){
  return str.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
}

// -----------------
// Attach click safely
// -----------------
submitBtn.removeAttribute("onclick"); // remove old inline onclick
submitBtn.addEventListener("click", submitMessage);
</script>
</body>
</html>
